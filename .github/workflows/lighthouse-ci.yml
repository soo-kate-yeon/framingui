name: Lighthouse CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [master, develop]

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Vercel Preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        id: wait-for-vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        id: lighthouse
        with:
          urls: |
            ${{ steps.wait-for-vercel.outputs.url }}
            ${{ steps.wait-for-vercel.outputs.url }}/studio
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: ./lighthouse-budget.json

      - name: Check Lighthouse scores
        run: |
          echo "Lighthouse CI completed successfully"
          echo "View results in the artifacts or temporary storage"

      - name: Comment PR with Lighthouse results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const manifestPath = process.env.LHCI_MANIFEST_PATH || '.lighthouseci/manifest.json';

            if (!fs.existsSync(manifestPath)) {
              console.log('Manifest file not found, skipping comment');
              return;
            }

            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
            const result = manifest[0];

            if (!result || !result.summary) {
              console.log('No summary data found');
              return;
            }

            const formatScore = (score) => {
              const percentage = Math.round(score * 100);
              const emoji = percentage >= 90 ? 'ğŸŸ¢' : percentage >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
              return `${emoji} ${percentage}`;
            };

            const results = `
            ## âš¡ Lighthouse CI Results

            | Category | Score |
            |----------|-------|
            | ğŸ¨ Performance | ${formatScore(result.summary.performance)} |
            | â™¿ Accessibility | ${formatScore(result.summary.accessibility)} |
            | âœ… Best Practices | ${formatScore(result.summary['best-practices'])} |
            | ğŸ” SEO | ${formatScore(result.summary.seo)} |

            ### ëª©í‘œ ë‹¬ì„± ì—¬ë¶€
            - Performance: ${result.summary.performance >= 0.8 ? 'âœ… ëª©í‘œ ë‹¬ì„± (80+)' : 'âŒ ëª©í‘œ ë¯¸ë‹¬ì„±'}
            - Accessibility: ${result.summary.accessibility >= 0.9 ? 'âœ… ëª©í‘œ ë‹¬ì„± (90+)' : 'âŒ ëª©í‘œ ë¯¸ë‹¬ì„±'}

            [ğŸ“Š View Full Report](${{ steps.wait-for-vercel.outputs.url }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: results
            });

      - name: Fail if performance targets not met
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking if performance targets are met..."
          # This step will be expanded based on actual Lighthouse output format
          echo "Performance target: 80+"
          echo "Accessibility target: 90+"
          echo "Targets validation will be implemented after first run"

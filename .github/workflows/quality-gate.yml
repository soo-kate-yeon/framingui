name: Quality Gate

on:
  push:
    branches: [master, main, develop, 'feature/**', 'feat/**']
  pull_request:
    branches: [master, main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint:all

      - name: Check code formatting
        run: pnpm exec prettier --check "packages/*/src/**/*.{ts,tsx}" "packages/*/__tests__/**/*.{ts,tsx}" "*.{ts,js,json}" ".github/**/*.yml"

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: lint-results
          path: |
            eslint-report.json
          retention-days: 7

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript compiler
        run: |
          # Type check core packages (mcp-server has separate build with @tekton/ui)
          pnpm exec tsc --build packages/core packages/tokens packages/styled packages/esbuild-plugin --force

      - name: Upload type check errors
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: type-check-errors
          path: |
            build-errors.log
          retention-days: 7

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm ci:test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-tekton
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 30

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify workspace dependencies
        run: pnpm list --depth 0

      - name: Build all packages
        run: pnpm --filter "./packages/*" build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/*/dist/
            packages/*/build/
          retention-days: 7

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "::error::One or more quality gates failed"
            exit 1
          fi
          echo "‚úÖ All quality gates passed"

  auto-fix:
    name: Auto-fix on Failure
    runs-on: ubuntu-latest
    needs: [quality-summary]
    # Run only on feature branches when quality-summary fails
    if: failure() && github.ref != 'refs/heads/master' && github.ref != 'refs/heads/main'
    permissions:
      contents: write
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check retry count
        id: retry-check
        run: |
          AUTO_FIX_COUNT=$(git log --since="24 hours ago" --grep="auto-fix CI/CD" --oneline | wc -l)
          echo "auto_fix_count=$AUTO_FIX_COUNT" >> $GITHUB_OUTPUT

          if [ $AUTO_FIX_COUNT -ge 3 ]; then
            echo "‚ö†Ô∏è Maximum retry attempts (3) reached in last 24 hours"
            echo "should_fix=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ Retry count: $AUTO_FIX_COUNT/3"
            echo "should_fix=true" >> $GITHUB_OUTPUT
          fi

      - name: Run simple auto-fixes
        id: simple-fixes
        continue-on-error: true
        run: |
          echo "üîß Running ESLint auto-fix..."
          pnpm lint:all --fix || true

          echo "üé® Running Prettier auto-format..."
          pnpm exec prettier --write "packages/*/src/**/*.{ts,tsx}" "packages/*/__tests__/**/*.{ts,tsx}" || true

      - name: Check for changes after simple fixes
        id: check-simple-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Simple fixes applied:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No simple fixes available"
          fi

      - name: Commit and push simple fixes
        if: steps.check-simple-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          ATTEMPT_NUM=$(($(git log --since="24 hours ago" --grep="auto-fix CI/CD" --oneline | wc -l) + 1))

          cat << EOF > commit_message.txt
          chore: auto-fix CI/CD failures (attempt $ATTEMPT_NUM/3)

          Automated fixes applied:
          - ESLint --fix
          - Prettier --write

          Workflow run: ${{ github.run_id }}
          EOF

          git commit -F commit_message.txt
          git push

      - name: Summary
        if: always()
        run: |
          echo "## Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-simple-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Simple fixes were applied and committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Quality Gate will re-run automatically" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è No automatic fixes were available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Manual intervention required" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Retry count: ${{ steps.retry-check.outputs.auto_fix_count }}/3" >> $GITHUB_STEP_SUMMARY

name: Deploy to Vercel
# 아키텍처:
#   1. Push → Quality Gate 실행
#   2. QG 성공 → 이 워크플로우가 Deploy Hook 트리거
#   3. Vercel 빌드 시작 → Ignored Build Step이 GitHub API로 QG 상태 재검증
#   4. QG 통과 확인 → 빌드 진행
#
# Vercel Dashboard 설정 필수:
#   - Ignored Build Step: 커스텀 스크립트 (GitHub API 검증)
#   - 환경변수: GH_API_TOKEN (GitHub PAT, Actions read 권한)

on:
  workflow_run:
    workflows: ['Quality Gate']
    types:
      - completed
    branches:
      - master
      - main

permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  deploy:
    name: Deploy to Vercel
    # Quality Gate 성공 시에만 배포
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Trigger Vercel Deployment via Deploy Hook
        id: deploy
        run: |
          echo "Triggering Vercel deployment for branch: ${{ github.event.workflow_run.head_branch }}"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -1)

          echo "Response: $HTTP_CODE"
          echo "Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Vercel deployment triggered successfully"
            # Deploy Hook 응답에서 URL 추출 (가능한 경우)
            DEPLOY_URL=$(echo "$BODY" | jq -r '.url // empty' 2>/dev/null || true)
            if [ -n "$DEPLOY_URL" ]; then
              echo "deployment_url=https://$DEPLOY_URL" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::Failed to trigger Vercel deployment (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## Vercel Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "Vercel deployment triggered via Deploy Hook." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Build is running on Vercel. Check the Vercel Dashboard for progress." >> $GITHUB_STEP_SUMMARY
          else
            echo "Failed to trigger deployment." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Quality Gate: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_STEP_SUMMARY

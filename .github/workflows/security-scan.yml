name: Security Scan

on:
  push:
    branches: ['**']
  pull_request:
    branches: [master, main, develop]
  schedule:
    # 매주 월요일 오전 9시 (KST) 자동 스캔
    - cron: '0 0 * * 1'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit (critical and high only)
        run: |
          echo "Running npm audit for critical and high vulnerabilities..."
          pnpm audit --audit-level=high --prod 2>&1 | tee audit-results.txt || true

      - name: Check audit results
        id: audit-check
        run: |
          if grep -q "found 0 vulnerabilities" audit-results.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ No critical or high vulnerabilities found"
          elif grep -qE "(critical|high)" audit-results.txt; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "❌ Critical or high vulnerabilities detected"
            exit 1
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "⚠️ Some vulnerabilities found, but below high severity"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-results
          path: audit-results.txt
          retention-days: 30

      - name: Comment PR with audit results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditResults = fs.readFileSync('audit-results.txt', 'utf8');

            let comment = '## 보안 스캔 결과 (npm audit)\n\n';

            if (auditResults.includes('found 0 vulnerabilities')) {
              comment += '✅ Critical 및 High 취약점이 발견되지 않았습니다.\n';
            } else {
              comment += '⚠️ 취약점이 발견되었습니다:\n\n';
              comment += '```\n' + auditResults.substring(0, 1000) + '\n```\n\n';
              comment += '전체 보고서는 아티팩트를 다운로드하여 확인하세요.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency vulnerability check
        run: |
          echo "Checking for known vulnerabilities in dependencies..."

          # package.json의 dependencies 스캔
          find packages -name "package.json" -type f -exec echo "Scanning: {}" \; -exec cat {} \;

          # pnpm list로 전체 의존성 트리 확인
          pnpm list --depth=0 --json > dependency-tree.json || true

      - name: Upload dependency tree
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree
          path: dependency-tree.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, dependency-check]
    if: always()

    steps:
      - name: Check security scan status
        run: |
          if [ "${{ needs.npm-audit.result }}" == "failure" ]; then
            echo "::error::npm audit detected critical or high vulnerabilities"
            exit 1
          fi

          if [ "${{ needs.npm-audit.result }}" == "success" ] && \
             [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "✅ All security scans passed"
          else
            echo "⚠️ Some security checks completed with warnings"
          fi

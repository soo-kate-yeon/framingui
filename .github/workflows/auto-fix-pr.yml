name: Auto-fix PR Checks

on:
  workflow_run:
    workflows: ['Quality Gate']
    types:
      - completed
    branches-ignore:
      - main
      - master

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-fix:
    name: Auto-fix Failed Checks
    # Only run on PR branches when quality gate fails
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download failed workflow logs
        id: download-logs
        continue-on-error: true
        run: |
          echo "Downloading logs from workflow run ${{ github.event.workflow_run.id }}"
          gh run view ${{ github.event.workflow_run.id }} --log > workflow_logs.txt || echo "Could not download logs"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze logs and determine fixes
        id: analyze
        run: |
          LOG_FILE="workflow_logs.txt"

          # Initialize flags
          echo "needs_lint_fix=false" >> $GITHUB_OUTPUT
          echo "needs_format_fix=false" >> $GITHUB_OUTPUT
          echo "needs_type_check=false" >> $GITHUB_OUTPUT

          if [ -f "$LOG_FILE" ]; then
            # Check for lint errors
            if grep -qi "eslint\|lint" "$LOG_FILE"; then
              echo "needs_lint_fix=true" >> $GITHUB_OUTPUT
              echo "üîç Detected linting issues"
            fi
            
            # Check for formatting errors
            if grep -qi "prettier\|format" "$LOG_FILE"; then
              echo "needs_format_fix=true" >> $GITHUB_OUTPUT
              echo "üîç Detected formatting issues"
            fi
            
            # Check for type errors
            if grep -qi "typescript\|tsc\|type error" "$LOG_FILE"; then
              echo "needs_type_check=true" >> $GITHUB_OUTPUT
              echo "üîç Detected TypeScript issues"
            fi
          else
            echo "‚ö†Ô∏è No log file found, will attempt common fixes"
            echo "needs_lint_fix=true" >> $GITHUB_OUTPUT
            echo "needs_format_fix=true" >> $GITHUB_OUTPUT
          fi

      - name: Run ESLint auto-fix
        if: steps.analyze.outputs.needs_lint_fix == 'true'
        continue-on-error: true
        run: |
          echo "üîß Running ESLint auto-fix..."
          pnpm --filter "./packages/*" exec eslint --fix "src/**/*.{ts,tsx}" "__tests__/**/*.{ts,tsx}" || true

      - name: Run Prettier auto-fix
        if: steps.analyze.outputs.needs_format_fix == 'true'
        continue-on-error: true
        run: |
          echo "üé® Running Prettier auto-fix..."
          pnpm exec prettier --write "packages/*/src/**/*.{ts,tsx}" "packages/*/__tests__/**/*.{ts,tsx}" "*.{ts,js,json}" ".github/**/*.yml" || true

      - name: Install Claude Code CLI
        if: |
          steps.analyze.outputs.needs_type_check == 'true' ||
          steps.analyze.outputs.needs_lint_fix == 'true'
        continue-on-error: true
        run: |
          echo "üì¶ Installing Claude Code CLI..."
          npm install -g @anthropic-ai/claude-code || echo "‚ö†Ô∏è Claude Code installation failed, continuing with basic fixes"

      - name: Run MoAI Loop Auto-fix
        if: |
          steps.analyze.outputs.needs_type_check == 'true' ||
          steps.analyze.outputs.needs_lint_fix == 'true'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Running MoAI Loop to fix errors..."

          # Check if Claude Code is installed
          if ! command -v claude &> /dev/null; then
            echo "‚ö†Ô∏è Claude Code CLI not available, skipping AI-powered fixes"
            exit 0
          fi

          # Check if API key is configured
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "‚ö†Ô∏è ANTHROPIC_API_KEY not configured, skipping AI-powered fixes"
            echo "üí° Add ANTHROPIC_API_KEY to GitHub Secrets to enable intelligent auto-fixing"
            exit 0
          fi

          # Create error context file from workflow logs
          echo "üìù Creating error context from workflow logs..."
          cat > error_context.md << 'EOF'
          # CI/CD Failure Report

          Quality Gate failed. Please analyze the errors and fix them.

          ## Workflow Logs
          EOF

          if [ -f "workflow_logs.txt" ]; then
            echo '```' >> error_context.md
            tail -n 200 workflow_logs.txt >> error_context.md
            echo '```' >> error_context.md
          fi

          # Run MoAI Loop in headless mode
          echo "üîÑ Executing /moai:loop to fix all errors..."
          claude code -p "/moai:loop $(cat error_context.md)" \
            --allowedTools Read,Write,Edit,Bash,Glob,Grep,Task \
            --non-interactive || echo "‚ö†Ô∏è MoAI Loop completed with warnings"

          echo "‚úÖ MoAI Loop auto-fix completed"

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Commit and push fixes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          cat << EOF > commit_message.txt
          chore: auto-fix CI/CD failures with MoAI Loop

          Auto-fixes applied by GitHub Actions:
          - ESLint auto-fix
          - Prettier formatting
          - MoAI Loop intelligent error correction

          Triggered by failed workflow run: ${{ github.event.workflow_run.id }}
          Original workflow: ${{ github.event.workflow_run.html_url }}
          EOF

          git commit -F commit_message.txt
          git push

      - name: Add comment to PR
        if: steps.check-changes.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            cat << 'COMMENT_EOF' > pr_comment.txt
          ü§ñ **Auto-fix Applied with MoAI Loop**

          I've automatically fixed CI/CD failures using intelligent analysis:
          - ‚úÖ ESLint issues
          - ‚úÖ Prettier formatting
          - üß† MoAI Loop intelligent error correction
            - TypeScript type errors
            - Build errors
            - Test failures

          The checks should re-run automatically. MoAI Loop will continue fixing issues until all tests pass.
          COMMENT_EOF
            
            echo "" >> pr_comment.txt
            echo "Workflow run: ${{ github.event.workflow_run.html_url }}" >> pr_comment.txt
            
            gh pr comment $PR_NUMBER --body-file pr_comment.txt
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Fixes were applied and committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes made:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 --stat >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è No automatic fixes were available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### MoAI Loop Status" >> $GITHUB_STEP_SUMMARY
            if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
              echo "‚ö†Ô∏è ANTHROPIC_API_KEY not configured" >> $GITHUB_STEP_SUMMARY
              echo "Add API key to GitHub Secrets to enable intelligent auto-fixing" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ MoAI Loop is enabled and attempted fixes" >> $GITHUB_STEP_SUMMARY
              echo "Manual intervention may still be required for complex errors" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Original workflow: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_STEP_SUMMARY

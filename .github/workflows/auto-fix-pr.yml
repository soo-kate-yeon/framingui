name: Auto-fix PR Checks

on:
  workflow_run:
    workflows: ['Quality Gate']
    types:
      - completed
    branches-ignore:
      - main
      - master

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-fix:
    name: Auto-fix Failed Checks
    # Run when quality gate fails (both push and pull_request events)
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download failed workflow logs
        id: download-logs
        continue-on-error: true
        run: |
          echo "Downloading logs from workflow run ${{ github.event.workflow_run.id }}"
          gh run view ${{ github.event.workflow_run.id }} --log > workflow_logs.txt || echo "Could not download logs"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze logs and determine fixes
        id: analyze
        run: |
          LOG_FILE="workflow_logs.txt"

          echo "needs_ai_fix=false" >> $GITHUB_OUTPUT

          if [ -f "$LOG_FILE" ]; then
            # Check for errors that need AI-powered fixes
            if grep -qi "typescript\|tsc\|type error\|build\|test.*fail" "$LOG_FILE"; then
              echo "needs_ai_fix=true" >> $GITHUB_OUTPUT
              echo "ðŸ” Detected complex errors requiring AI-powered fixes"
              echo "   - TypeScript type errors"
              echo "   - Build failures"
              echo "   - Test failures"
            fi
          else
            echo "âš ï¸ No log file found, will attempt AI-powered fixes"
            echo "needs_ai_fix=true" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "ðŸ’¡ Note: ESLint/Prettier are handled by pre-commit hook"
          echo "   CI/CD Auto-fix focuses on complex errors only"

      - name: Install Claude Code CLI
        if: steps.analyze.outputs.needs_ai_fix == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Installing Claude Code CLI..."
          npm install -g @anthropic-ai/claude-code || echo "âš ï¸ Claude Code installation failed, continuing with basic fixes"

      - name: Run MoAI Loop Auto-fix
        if: steps.analyze.outputs.needs_ai_fix == 'true'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ¤– Running MoAI Loop to fix errors..."

          # Check if Claude Code is installed
          if ! command -v claude &> /dev/null; then
            echo "âš ï¸ Claude Code CLI not available, skipping AI-powered fixes"
            exit 0
          fi

          # Check if API key is configured
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âš ï¸ ANTHROPIC_API_KEY not configured, skipping AI-powered fixes"
            echo "ðŸ’¡ Add ANTHROPIC_API_KEY to GitHub Secrets to enable intelligent auto-fixing"
            exit 0
          fi

          # Create error context file from workflow logs
          echo "ðŸ“ Creating error context from workflow logs..."
          cat > error_context.md << 'EOF'
          # CI/CD Failure Report

          Quality Gate failed. Please analyze the errors and fix them.

          ## Workflow Logs
          EOF

          if [ -f "workflow_logs.txt" ]; then
            echo '```' >> error_context.md
            tail -n 200 workflow_logs.txt >> error_context.md
            echo '```' >> error_context.md
          fi

          # Run MoAI Loop in headless mode
          echo "ðŸ”„ Executing /moai:loop to fix all errors..."
          claude code -p "/moai:loop $(cat error_context.md)" \
            --allowedTools Read,Write,Edit,Bash,Glob,Grep,Task \
            --non-interactive || echo "âš ï¸ MoAI Loop completed with warnings"

          echo "âœ… MoAI Loop auto-fix completed"

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Check retry count
        id: retry-check
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Count recent auto-fix commits in last 24 hours
          AUTO_FIX_COUNT=$(git log --since="24 hours ago" --grep="auto-fix CI/CD" --oneline | wc -l)
          echo "auto_fix_count=$AUTO_FIX_COUNT" >> $GITHUB_OUTPUT

          if [ $AUTO_FIX_COUNT -ge 3 ]; then
            echo "âš ï¸ Maximum retry attempts (3) reached in last 24 hours"
            echo "should_commit=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Retry count: $AUTO_FIX_COUNT/3"
            echo "should_commit=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push fixes
        if: |
          steps.check-changes.outputs.has_changes == 'true' &&
          steps.retry-check.outputs.should_commit == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          ATTEMPT_NUM=$(($(git log --since="24 hours ago" --grep="auto-fix CI/CD" --oneline | wc -l) + 1))

          cat << EOF > commit_message.txt
          fix(ci): auto-fix complex errors with MoAI Loop (attempt $ATTEMPT_NUM/3)

          AI-powered fixes applied by GitHub Actions:
          - TypeScript type errors
          - Build failures
          - Test failures
          - Dependency issues

          Note: ESLint/Prettier are handled by pre-commit hook locally

          Triggered by failed workflow run: ${{ github.event.workflow_run.id }}
          Original workflow: ${{ github.event.workflow_run.html_url }}
          EOF

          git commit -F commit_message.txt
          git push

      - name: Add comment to PR
        if: steps.check-changes.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            ATTEMPT_NUM=$(($(git log --since="24 hours ago" --grep="auto-fix CI/CD" --oneline | wc -l) + 1))

            if [ "${{ steps.retry-check.outputs.should_commit }}" == "true" ]; then
              cat << COMMENT_EOF > pr_comment.txt
          ðŸ¤– **MoAI Loop Auto-fix Applied** (Attempt $ATTEMPT_NUM/3)

          I've automatically fixed complex CI/CD errors using AI:
          - ðŸ§  TypeScript type errors
          - ðŸ”¨ Build failures
          - ðŸ§ª Test failures
          - ðŸ“¦ Dependency issues

          The checks will re-run automatically. MoAI Loop will continue until all tests pass (max 3 attempts per 24h).

          ---
          ðŸ’¡ **Note**: ESLint/Prettier are handled by pre-commit hook locally.
          Run \`git commit\` again if you see lint/format errors.
          COMMENT_EOF
            else
              cat << COMMENT_EOF > pr_comment.txt
          âš ï¸ **Auto-fix Retry Limit Reached**

          Maximum retry attempts (3) reached in the last 24 hours.

          Auto-fix has attempted to fix the issues but couldn't resolve all errors automatically.
          Manual intervention is now required.

          Please review the errors and fix them manually.
          COMMENT_EOF
            fi

            echo "" >> pr_comment.txt
            echo "Workflow run: ${{ github.event.workflow_run.html_url }}" >> pr_comment.txt

            gh pr comment $PR_NUMBER --body-file pr_comment.txt
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Fixes were applied and committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes made:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 --stat >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No automatic fixes were available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### MoAI Loop Status" >> $GITHUB_STEP_SUMMARY
            if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
              echo "âš ï¸ ANTHROPIC_API_KEY not configured" >> $GITHUB_STEP_SUMMARY
              echo "Add API key to GitHub Secrets to enable intelligent auto-fixing" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… MoAI Loop is enabled and attempted fixes" >> $GITHUB_STEP_SUMMARY
              echo "Manual intervention may still be required for complex errors" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Original workflow: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_STEP_SUMMARY
